# Simple Docker
  

## Part 1. Готовый докер.

- Возьми официальный докер-образ с nginx и выкачай его при помощи docker pull.  

![alt text](</src/screens/Снимок экрана 2024-04-24 в 23.58.50.png>)  

- Проверь наличие докер-образа через docker images.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.01.32.png>)  

- Запусти докер-образ через docker run -d [image_id|repository]. 
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.28.18.png>)  

- Проверь, что образ запустился через docker ps.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.33.58.png>)  

- Посмотри информацию о контейнере через docker inspect [container_id|container_name].  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.45.17.png>)

- По выводу команды определи и помести в отчёт размер контейнера, список замапленных портов и ip контейнера.  

Размер:  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.43.03.png>)  

Запамленные порты:  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.48.47.png>)  

ip контейнера:  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.53.57.png>)  

- Останови докер образ через docker stop [container_id|container_name].  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.58.22.png>)  

- Проверь, что образ остановился через docker ps.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 00.59.52.png>)  

- Запусти докер с портами 80 и 443 в контейнере, замапленными на такие же порты на локальной машине, через команду run.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.06.36.png>)  

- Проверь, что в браузере по адресу localhost:80 доступна стартовая страница nginx.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.08.16.png>)  

- Перезапусти докер контейнер через docker restart [container_id|container_name].  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.11.56.png>)  

## Part 2. Операции с контейнером  

- Прочитай конфигурационный файл nginx.conf внутри докер контейнера через команду exec.  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.23.53.png>)  

- Создай на локальной машине файл nginx.conf.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.36.50.png>)  

- Настрой в нем по пути /status отдачу страницы статуса сервера nginx.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.43.39.png>)  

- Скопируй созданный файл nginx.conf внутрь докер-образа через команду docker cp.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.55.23.png>)  

- Перезапусти nginx внутри докер-образа через команду exec.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 01.57.27.png>)  

- Проверь, что по адресу localhost:80/status отдается страничка со статусом сервера nginx.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.01.58.png>)  

- Экспортируй контейнер в файл container.tar через команду export.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.23.47.png>)  

- Останови контейнер.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.25.17.png>)  

- Удали образ через docker rmi [image_id|repository], не удаляя перед этим контейнеры.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.31.25.png>)  

- Удали остановленный контейнер.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.34.23.png>)  

- Импортируй контейнер обратно через команду import.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.51.40.png>)  

- Запусти импортированный контейнер.  
  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.56.00.png>)  

- Проверь, что по адресу localhost:80/status отдается страничка со статусом сервера nginx.  
 
![alt text](</src/screens/Снимок экрана 2024-04-25 в 02.58.31.png>)  


## Part 3. Мини веб-сервер  

- Напиши мини-сервер на C и FastCgi, который будет возвращать простейшую страничку с надписью Hello World!.  
  
Код сервера на языке С:  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.19.00.png>)  

Свой nginx.conf на локальной машине, который будет проксировать все запросы с 81 порта на 127.0.0.1:8080:  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.28.59.png>)  

Снова берем докер-образ с nginx и выкачиваем его при помощи docker pull. Далее запускаем контейнер, копируем в него из локальной машины файл конфигурации и файл с кодом сервера.  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.42.19.png>)  
![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.45.39.png>)  

Затем подключаемся к контейнеру:  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.47.56.png>)  

Внутри контейнера устанавливаем необходимые библиотеки, компилятор:  

apt-get update  
apt-get install gcc  
apt-get install spawn-fcgi  
apt-get install libfcgi-dev  

Компилируем и запускаем сервер через spawn-fcgi, затем перезапуск nginx на контейнере nginx -s reload:  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 07.55.29.png>)  

Проверяем, что в браузере по localhost:81 отображается написанная страница:  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 08.00.25.png>)  

Копируем файл конфигурации для следующих заданий:  

![alt text](</src/screens/Снимок экрана 2024-04-25 в 08.16.14.png>)  

## Part 4. Свой докер  

- Напиши свой докер-образ, который:

1) собирает исходники мини сервера на FastCgi из Части 3;

2) запускает его на 8080 порту;

3) копирует внутрь образа написанный ./nginx/nginx.conf;

4) запускает nginx. (nginx можно установить внутрь докера самостоятельно, а можно воспользоваться готовым образом с nginx'ом, как базовым.)  

Докер-образ:  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.43.24.png>)  

Скрипт, компилирующий и запускающий server.c, nginx:  

 ![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.44.16.png>)

- Собери написанный докер-образ через docker build при этом указав имя и тег.    

![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.45.31.png>)  

- Проверь через docker images, что все собралось корректно.  
 
![images](</src/screens/Снимок экрана 2024-04-28 в 00.46.19.png>)  

- Запусти собранный докер-образ с маппингом 81 порта на 80 на локальной машине и маппингом папки ./nginx внутрь контейнера по адресу, где лежат конфигурационные файлы nginx'а (см. Часть 2).  
Проверь, что по localhost:80 доступна страничка написанного мини сервера.  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.47.41.png>)

- Допиши в ./nginx/nginx.conf проксирование странички /status, по которой надо отдавать статус сервера nginx.  
  
![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.54.29.png>)  

- Перезапусти докер-образ. Проверь, что теперь по localhost:80/status отдается страничка со статусом nginx  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 00.55.58.png>)  


## Part 5. Dockle  
- Просканируй образ из предыдущего задания через dockle [image_id|repository]  
 
Сначала нужно установить dockle, на мак ОС это команда brew install goodwithtech/r/dockle   

![alt text](</src/screens/Снимок экрана 2024-04-28 в 01.58.22.png>)  

ВВодим команду: dockle my_conteiner:102 и получаем ряд ошибок  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 01.54.54.png>)  

**Ошибки:**
* CIS-DI-0010: Если использовать в качестве базового образа nginx, то dockle необходимо запускать с дополнительными флагами. Команда будет выглядеть следующим образом dockle -i CIS-DI-0010 [image_name]:[image_tag]. Происходит это из-за запросов nginx ключей NGINX_GPGKEY.
* CIS-DI-0001 - Create a user for the container, last user should not be root: необходимо добавить пользователя без прав root;
*  CIS-DI-0005: перед build'ом необходимо выполнить команду export DOCKER_CONTENT_TRUST=1.
* CIS-DI-0006: необходимо добавить в образ инструкцию HEALTHCHECK, она используется для проверки состояния контейнера. В качестве аргументов передается --interval=30s - указывает интервал времени между проверками состояния контейнера;--timeout=3s - указывает максимальное время ожидания ответа от проверки состояния. 
* CIS-DI-0008: Confirm safety of setuid/setgid files: необходимо настроить права пользователей для работы с файлами по списку, разрешить всем запускать скрипт и исполняемые файлы, и настроить прва для работы с остальными файлами по списку;
* DKL-DI-0005: Clear apt-get caches - добавить в докерфайл инструкцию по удалению всего лишнего после установки нужных библиотек в команду RUN: rm -rf /var/lib/apt/lists

После исправления (тэг контейнера изменился, так как на всякий случай сделала билд заново с новым тэгом):  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 01.53.25.png>)  

Новый Докерфайл:  

![alt text](</src/screens/Снимок экрана 2024-04-28 в 01.53.59.png>)  

## Part 6. Базовый Docker Compose  

- Напиши файл docker-compose.yml, с помощью которого:

1) Подними докер-контейнер из Части 5 (он должен работать в локальной сети, т.е. не нужно использовать инструкцию EXPOSE и мапить порты на локальную машину).
Создаем 2 папки для двух контейнеров, server - туда копируем все из 5 задания, и nginx.  
 
nginx.conf в папке server:  
![alt text](</src/screens/Снимок экрана 2024-04-28 в 04.44.41.png>)  

2) Подними докер-контейнер с nginx, который будет проксировать все запросы с 8080 порта на 81 порт первого контейнера.
- Замапь 8080 порт второго контейнера на 80 порт локальной машины.  
nginx.conf в папке nginx:  
![alt text](</src/screens/Снимок экрана 2024-04-28 в 04.48.52.png>)  

- Останови все запущенные контейнеры.

- Собери и запусти проект с помощью команд docker-compose build и docker-compose up.

- Проверь, что в браузере по localhost:80 отдается написанная тобой страничка, как и ранее.

![alt text](</src/screens/Снимок экрана 2024-04-28 в 04.50.28.png>)  

